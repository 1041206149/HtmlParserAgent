# HtmlParserAgent 重构流程

## 1. 背景概述
- 现状：先对同一 HTML 反复生成 schema，再一次性生成解析器，缺乏迭代验证。
- 目标：以 URL 为迭代单位同步演进 schema 与解析代码，并在每轮验证所有历史页面。

## 2. 现有流程
1. 输入 HTML/URL，获取源码与渲染截图。
2. 使用 vLLM 对截图做视觉理解，产出含值 JSON。
3. 多轮调用模型补全字段，直至认为 schema 完整。
4. 结合 HTML 与 schema，一次性生成解析代码。
5. （可选）在当前 HTML 上做简单比对验证。

### 2.1 存在问题
- 迭代顺序与预期不符：解析器在 schema 固化后才生成，难以及时校验。
- 缺少 URL 级差异追踪：无法量化新页面对现有解析逻辑的影响。
- 验证面窄：仅验证当前 HTML，旧页面可能被新逻辑破坏。
- 空值字段没有显式标记“无需提取”，导致解析器冗余或报错。

## 3. 目标流程

### 3.1 首轮流程（基线）
1. **输入**：URL₀。
2. **渲染**：生成 HTML₀ 与截图。
3. **vLLM**：输出含 value 的 JSON₀。
4. **Schema 提取**：直接从 JSON₀ 生成 schema₀（字段、类型、约束）。
5. **解析器生成**：基于 HTML₀ + schema₀ + JSON₀，生成 URL₀ 专属解析代码 parser₀。
6. **验证**：用 HTML₀ 运行 parser₀，与 JSON₀ 对比，误差 ≤20% 则进入下一轮。

### 3.2 第 n≥2 轮迭代
1. **输入**：新 URLₙ、HTMLₙ、上一轮 schemaₙ₋₁、上一轮解析器 parserₙ₋₁。
2. **vLLM 输出**：得到 JSONₙ；空值字段标记为“不提取”。
3. **Schema 合并**：在 schemaₙ₋₁ 基础上补充字段/约束，形成 schemaₙ。
4. **解析器增量更新**：以 HTMLₙ + JSONₙ 为示例，对 parserₙ₋₁ 做增量补写/纠错，产出 parserₙ。
5. **全量验证**：
   - 对所有历史 HTML₀…ₙ 执行 parserₙ。
   - 真实值：每个 URL 对应的 vLLM JSON。
   - 预测值：parserₙ 结果。
   - 误差 >20% 的 URL 加入待回访队列。

### 3.3 待回访队列
- 保存高差异 URL；后续从队列中选择误差最大的 URL，再次执行 3.2。
- 队列可与外部 URL 资源池合并，保障优先修复不稳定页面。

### 3.4 终止条件
- 连续 m 轮差异均 <20%，且 schema 不再新增字段。
- 或达到迭代次数/资源预算上限。

## 4. 实施建议
- 将 `schema.json`、`generated_parser.py` 的生成逻辑拆分成：
  - **Schema 合并器**：负责 schema 演进与空值标记策略。
  - **解析器增量补全器**：支持基于示例 HTML/JSON 的差异补写。
- 引入差异评估模块，统一误差公式（字段缺失/错误占比 + 权重配置）。
- 记录每轮元数据（URL、schema 版本、parser 版本、差异分布），便于复现、回滚和 A/B 验证。
- 为待回访队列设计优先级策略（差异百分比、字段权重、业务价值）。

---
